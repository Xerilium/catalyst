---
id: catalyst-cli
title: Catalyst CLI
author: "@flanakin"
description: "This document defines the implementation plan for the Catalyst CLI feature for engineers. The document is generated by Catalyst AI and reviewed by the feature architect."
dependencies:
  - playbook-definition
  - playbook-engine
  - error-handling
---

<!-- markdownlint-disable single-title -->

# Implementation Plan: Catalyst CLI

**Spec**: [Feature spec](./spec.md)

---

## Summary

The Catalyst CLI provides a command-line interface for executing playbooks directly, without requiring an AI platform. The CLI uses PlaybookProvider for playbook discovery/loading and Engine for execution, exposing a minimal surface area with `catalyst run <playbook-id>` as the primary command. The feature enables manual testing of the playbook engine and establishes the foundation for future CLI expansion.

**Design rationale**: See [research.md](./research.md) for CLI framework analysis, command design patterns, and binary distribution research.

---

## Technical Context

This feature implementation plan extends the technical architecture defined in `.xe/architecture.md`.

**Feature-specific technical details:**

- **Primary Components**: CLI entry point (`bin/catalyst.js`), run command handler, output formatter, error handler
- **Data Structures**: CLI arguments/options parsed by CLI framework
- **Dependencies**: playbook-definition (PlaybookProvider), playbook-engine (Engine), error-handling (CatalystError)
- **Configuration**: None for MVP (future: `.xe/config/catalyst.json`)
- **Performance Goals**: <500ms startup for `--help` and `--version`
- **Testing Framework**: Jest with unit tests for argument parsing and integration tests for playbook execution
- **Key Constraints**: Node.js >= 18, cross-platform (macOS, Linux, Windows), human-readable output by default

---

## Project Structure

```text
bin/
  catalyst.js              # CLI entry point (shebang + bootstrap)
src/
  cli/
    index.ts               # CLI setup and command registration
    commands/
      run.ts               # Run command handler
    utils/
      output.ts            # Output formatting (banner, colors, progress)
      errors.ts            # CLI error handling (maps to exit codes)
    types.ts               # CLI-specific types
tests/
  unit/
    cli/
      commands/            # Command handler unit tests
      utils/               # Utility unit tests
  integration/
    cli/                   # End-to-end CLI tests
```

---

## Data Model

**Entities owned by this feature:**

- None (CLI is a thin wrapper over playbook-engine)

**Entities from other features:**

- **PlaybookProvider** (playbook-definition): Singleton for playbook discovery and loading
- **Engine** (playbook-engine): Playbook execution runtime
- **CatalystError** (error-handling): Error class with code, message, and guidance

---

## Contracts

### CLI Entry Point

**Signature:**

```typescript
// bin/catalyst.js
#!/usr/bin/env node
import { cli } from '../cli/index.js';
cli(process.argv);
```

**Purpose:** Bootstrap the CLI with command-line arguments

### cli Function

**Signature:**

```typescript
function cli(argv: string[]): Promise<void>;
```

**Purpose:** Parse arguments and execute appropriate command

**Parameters:**

- `argv` (string[]): Command-line arguments from process.argv

**Returns:** Promise that resolves when command completes

**Errors/Exceptions:** Exits process with appropriate exit code (0, 1, or 2)

### runCommand Function

**Signature:**

```typescript
async function runCommand(
  playbookId: string,
  inputs: Record<string, string>
): Promise<void>;
```

**Purpose:** Execute a playbook by ID with provided inputs

**Parameters:**

- `playbookId` (string): Playbook identifier for discovery
- `inputs` (Record<string, string>): Key-value inputs parsed from `--input` flags

**Returns:** Promise that resolves when playbook completes

**Errors/Exceptions:** Throws CatalystError with appropriate code (PlaybookNotFound, PlaybookExecutionFailed)

**Examples:**

```typescript
// Basic usage
await runCommand('start-blueprint', {});

// With inputs
await runCommand('start-rollout', {
  'feature-id': 'user-auth',
  'execution-mode': 'manual'
});
```

### formatError Function

**Signature:**

```typescript
function formatError(error: CatalystError): string;
```

**Purpose:** Format error for human-readable terminal output

**Parameters:**

- `error` (CatalystError): Error with code, message, and guidance

**Returns:** Formatted error string with color highlighting

### getExitCode Function

**Signature:**

```typescript
function getExitCode(error: CatalystError): number;
```

**Purpose:** Map error codes to exit codes

**Parameters:**

- `error` (CatalystError): Error to map

**Returns:** Exit code (1 for general errors, 2 for usage errors)

---

## Implementation Approach

### 1. CLI Framework Setup

The CLI uses a framework (e.g., Commander.js) for argument parsing:

1. Create program with name "catalyst" and version from package.json
2. Configure global options: `--help`, `--version`, `--quiet`
3. Register `run` subcommand with `<playbook-id>` argument
4. Register `--input` option as repeatable (`-i, --input <key=value>`)
5. Set up error handling to catch unhandled rejections
6. Display help when no command provided

### 2. Run Command Implementation

**runCommand(playbookId, inputs) algorithm:**

1. Display "Running playbook: {playbookId}..." if not quiet
2. Load playbook via `PlaybookProvider.getInstance().loadPlaybook(playbookId)`
3. If playbook not found, throw CatalystError with code `PlaybookNotFound`
4. Create Engine instance
5. Execute playbook: `await engine.run(playbook, inputs)`
6. If execution fails, wrap error in CatalystError with code `PlaybookExecutionFailed`
7. Display "Playbook completed successfully" on success

### 3. Input Parsing

Parse `--input key=value` flags into Record<string, string>:

1. For each input string:
   - Split on first `=` character
   - If no `=` found, throw CatalystError with code `InvalidInput`
   - Add to inputs object: `inputs[key] = value`
2. Return populated inputs object

### 4. Output Formatting

**Banner display:**

1. Generate ASCII art text "Catalyst" using basic characters
2. Display on `--help` output only
3. Skip if `--quiet` flag set or `NO_COLOR` env var

**Progress display:**

1. Detect TTY via `process.stdout.isTTY`
2. If TTY: use spinner for long operations
3. If non-TTY: use log-style output

**Color handling:**

1. Check `NO_COLOR` environment variable
2. If set, disable all ANSI color codes
3. Otherwise, use colors for emphasis (green success, red errors, cyan info)

### 5. Error Handling

**Error mapping:**

| CatalystError Code | Exit Code | Display |
|--------------------|-----------|---------|
| `PlaybookNotFound` | 1 | Red error message with guidance |
| `InvalidInput` | 2 | Red error message with usage example |
| `MissingPlaybookId` | 2 | Red error message with usage |
| `PlaybookExecutionFailed` | 1 | Red error message with details |
| Other codes | 1 | Generic error display |

**Error format:**

```
Error [{code}]: {message}

{guidance}
```

### 6. Shell Completion

Generate completion scripts for bash, zsh, fish, and PowerShell:

1. Add `completion` subcommand to CLI
2. `catalyst completion bash` outputs bash completion script
3. `catalyst completion zsh` outputs zsh completion script
4. `catalyst completion fish` outputs fish completion script
5. `catalyst completion powershell` outputs PowerShell completion script
6. Scripts complete command names and `--input` flag

### 7. Integration Points

**Consumed by:**

- Users running playbooks from terminal
- CI/CD pipelines
- Future: Dynamic command registration

**Depends on:**

- **playbook-definition**: PlaybookProvider for loading playbooks
- **playbook-engine**: Engine for executing playbooks
- **error-handling**: CatalystError for consistent error reporting

### 8. Error Handling

1. **Unknown command**: Display help with available commands
2. **Missing playbook ID**: Throw CatalystError with code `MissingPlaybookId`
3. **Playbook not found**: Throw CatalystError with code `PlaybookNotFound`
4. **Invalid input format**: Throw CatalystError with code `InvalidInput`
5. **Playbook execution failure**: Wrap engine error in CatalystError with code `PlaybookExecutionFailed`
6. **Unhandled errors**: Log stack trace (if verbose), exit with code 1

### 9. Performance Considerations

1. **Lazy loading**: Only import playbook-engine when `run` command invoked
2. **Minimal dependencies**: Keep CLI bootstrap minimal for fast `--help`
3. **No unnecessary I/O**: Don't read config files for `--help` or `--version`

### 10. Testing Strategy

**Unit Tests:**

1. **Argument parsing tests**: Valid commands, invalid commands, input parsing
2. **Error formatting tests**: All error codes produce correct output and exit codes
3. **Output formatting tests**: Banner display, color handling, NO_COLOR support

**Integration Tests:**

1. **Help command**: `catalyst --help` displays banner and commands
2. **Version command**: `catalyst --version` displays package version
3. **Run command**: `catalyst run <playbook>` executes playbook
4. **Error scenarios**: Missing playbook, invalid inputs, execution failures

**Manual Testing:**

1. Run `catalyst --help` and verify output
2. Run `catalyst --version` and verify version
3. Run `catalyst run <test-playbook>` with a simple test playbook
4. Test on macOS, Linux, and Windows terminals

### 11. Documentation Plan

**Target Audience:** Developers using Catalyst CLI

**Documentation Type:** User guide with examples

**File Location:** `docs/cli.md` (deferred - no customer-facing docs for MVP)

**Content Outline (future):**

1. Installation
2. Basic usage
3. Running playbooks
4. Input parameters
5. Shell completion setup
6. Exit codes reference

---

## Usage Examples

### Basic Usage: Running a Playbook

```bash
# Show help
catalyst --help

# Show version
catalyst --version

# Run a playbook
catalyst run start-blueprint

# Run with inputs
catalyst run start-rollout --input feature-id=user-auth --input execution-mode=manual

# Short form for inputs
catalyst run start-rollout -i feature-id=user-auth -i execution-mode=manual
```

### Integration Pattern: CI Pipeline

```yaml
# .github/workflows/blueprint.yml
jobs:
  blueprint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm install
      - run: npx catalyst run start-blueprint
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```
